<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="create_application_user_and_role_tables" author="emiliano">
        <sql>
            create table application_user
            (
                id         bigserial primary key,
                username   text    not null unique,
                name       text    not null,
                password   text    not null,
                enabled    boolean not null default true,

                version    integer,
                created_at timestamp,
                created_by text,
                updated_at timestamp,
                updated_by text
            );

            create table application_user_role
            (
                id                  bigserial primary key,
                application_user_id bigint not null references application_user (id),
                role                text   not null,

                version             integer,
                created_at          timestamp,
                created_by          text,
                updated_at          timestamp,
                updated_by          text
            );
            create index application_user_role_application_user_id_index on application_user_role (application_user_id);

        </sql>
    </changeSet>

    <changeSet id="create_admin_user" author="emiliano">
        <sql>
            insert into application_user (username, name, enabled, password, created_at, created_by)
            values ('admin', 'Emiliano Xhukellari', true,
                    '$2a$10$jpLNVNeA7Ar/ZQ2DKbKCm.MuT2ESe.Qop96jipKMq7RaUgCoQedV.',
                    now(),
                    'system');
        </sql>
    </changeSet>

    <changeSet id="add_roles_to_admin_user" author="emiliano">
        <sql>
            insert into application_user_role (application_user_id, role, created_at, created_by)
            values ((select id from application_user where username = 'admin'), 'ADMIN', now(), 'system');

            insert into application_user_role (application_user_id, role, created_at, created_by)
            values ((select id from application_user where username = 'admin'), 'USER', now(), 'system');
        </sql>
    </changeSet>

    <changeSet id="add_operation_table" author="emiliano">
        <sql>
            create table operation
            (
                id          bigserial primary key,
                name        text      not null,
                type        text      not null,
                status      text      not null,
                error       text,
                started_at  timestamp not null,
                ended_at    timestamp,
                description text,

                version     integer,
                created_at  timestamp,
                created_by  text,
                updated_at  timestamp,
                updated_by  text
            );
        </sql>
    </changeSet>

    <changeSet id="add_transcription_table" author="emiliano">
        <sql>
            create table transcription
            (
                id                         bigserial primary key,
                status                     text                                    not null,
                source_uri                 text                                    not null,
                cloud_uri                  text,
                language                   text                                    not null,
                name                       text                                    not null,
                application_user_id        bigint references application_user (id) not null,
                enhanced                   boolean                                 not null,
                length_millis              bigint,
                download_duration_millis   bigint,
                process_duration_millis    bigint,
                transcribe_duration_millis bigint,
                transcribe_progress        integer,
                error                      text,

                version                    integer,
                created_at                 timestamp,
                created_by                 text,
                updated_at                 timestamp,
                updated_by                 text
            );

            create index transcription_application_user_id_index on transcription (application_user_id);

        </sql>
    </changeSet>

    <changeSet id="add_completion_table" author="emiliano">
        <sql>
            create table completion
            (
                id               bigserial primary key,
                transcription_id bigint references transcription (id) not null,
                input            text                                 not null,
                output           text,
                input_tokens     integer,
                output_tokens    integer,
                model            text,
                temperature      double precision,
                top_p            double precision,
                status           text                                 not null,
                duration_millis  bigint,
                error            text,

                version          integer,
                created_at       timestamp,
                created_by       text,
                updated_at       timestamp,
                updated_by       text
            );
            create index completion_transcription_id_index on completion (transcription_id);
        </sql>
    </changeSet>

    <changeSet id="add_transcript_part_table" author="emiliano">
        <sql>
            create table transcript_part
            (
                id                  bigserial primary key,
                transcription_id    bigint references transcription (id) not null,
                start_offset_millis bigint                               not null,
                end_offset_millis   bigint                               not null,
                sequence            integer                              not null,
                end_of_partition    boolean                              not null,

                version             integer,
                created_at          timestamp,
                created_by          text,
                updated_at          timestamp,
                updated_by          text,

                unique (transcription_id, sequence)
            );
            create index transcript_part_transcription_id_index on transcript_part (transcription_id);
            create index transcript_part_sequence_index on transcript_part (sequence);
        </sql>
    </changeSet>

    <changeSet id="add_transcript_part_text" author="emiliano">
        <sql>
            create table transcript_part_text
            (
                id                 bigserial primary key,
                transcript_part_id bigint references transcript_part (id) not null,
                content            text                                   not null,
                version2            integer                                not null,
                type               text                                   not null,

                version            integer,
                created_at         timestamp,
                created_by         text,
                updated_at         timestamp,
                updated_by         text,

                unique (transcript_part_id, version)
            );
            create index transcript_part_text_transcript_part_id_version_index
                on transcript_part_text (transcript_part_id, version);
            create index transcript_part_text_transcript_part_id_type_index
                on transcript_part_text (transcript_part_id, type);
        </sql>
    </changeSet>

    <changeSet id="add_settings_table" author="emiliano">
        <sql>
            create table settings
            (
                id         bigserial primary key,
                key        text  not null unique,
                name       text  not null,
                value      jsonb not null,

                version    integer,
                created_at timestamp,
                created_by text,
                updated_at timestamp,
                updated_by text
            );
            create index settings_key_index on settings (key);
        </sql>
    </changeSet>

    <changeSet id="add_template_table" author="emiliano">
        <sql>
            create table template
            (
                id         bigserial primary key,
                name       text not null unique,
                content    text not null,

                version    integer,
                created_at timestamp,
                created_by text,
                updated_at timestamp,
                updated_by text
            );
            create index template_name_index on template (name);
        </sql>
    </changeSet>

    <changeSet id="add_transcription_speaker_table" author="emiliano">
        <sql>
            create table transcription_speaker
            (
                id               bigserial primary key,
                name             text                                 not null,
                transcription_id bigint references transcription (id) not null,

                version          integer,
                created_at       timestamp,
                created_by       text,
                updated_at       timestamp,
                updated_by       text,

                unique (transcription_id, name)
            );
            create index transcription_speaker_transcription_id_index on transcription_speaker (transcription_id);
        </sql>
    </changeSet>

    <changeSet id="add_transcription_word_table" author="emiliano">
        <sql>
            create table transcription_word
            (
                id                       bigserial primary key,
                transcription_id         bigint references transcription (id)         not null,
                transcription_speaker_id bigint references transcription_speaker (id) not null,
                sequence                 integer                                      not null,
                start_offset_millis      bigint                                       not null,
                end_offset_millis        bigint                                       not null,
                content                  text                                         not null,

                version                  integer,
                created_at               timestamp,
                created_by               text,
                updated_at               timestamp,
                updated_by               text,

                unique (transcription_id, sequence)
            );
            alter sequence transcription_word_id_seq increment by 30;
            create index transcription_word_transcription_id_index on transcription_word (transcription_id);
            create index transcription_word_transcription_speaker_id_index on transcription_word (transcription_speaker_id);
            create index transcription_word_sequence_index on transcription_word (sequence);
        </sql>
    </changeSet>

</databaseChangeLog>